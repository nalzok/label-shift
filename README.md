# Test time label shift adaptation

## CMNIST

Hyper-parameters

```bash
pipenv run python3 \
    -m tta.cli \
    --dataset_name MNIST \
    --train_domains 0 \
    --train_batch_size 64 \
    --train_fraction 0.8 \
    --train_steps 1000 \
    --train_lr 1e-3 \
    --source_prior_estimation induce \
    --calibration_batch_size 64 \
    --calibration_fraction 0.1 \
    --calibration_temperature 10 \
    --calibration_steps 100 \
    --calibration_multiplier 1 \
    --test_batch_size 512 \
    --seed 360234358 \
    --num_workers 8 \
    --log_dir logs
```

Results

```
===> Adapting & Evaluating
---> Environment 0 (seen)
Ground truth p(y, z) = [[0.0025 0.0025 0.0116 0.0841]
 [0.0028 0.0127 0.0028 0.0925]
 [0.0113 0.0025 0.0025 0.0822]
 [0.0866 0.0026 0.0026 0.0119]
 [0.0024 0.0024 0.0111 0.0806]
 [0.0103 0.0022 0.0022 0.0749]
 [0.0024 0.0024 0.0024 0.0897]
 [0.0026 0.0026 0.0874 0.012 ]
 [0.0819 0.0113 0.0025 0.0025]
 [0.0025 0.0025 0.0116 0.0839]]
Estimated p(y, z) = [[0.0048 0.0138 0.019  0.0367]
 [0.0157 0.0312 0.0045 0.0455]
 [0.0043 0.008  0.0254 0.0846]
 [0.0241 0.0175 0.0219 0.0022]
 [0.0046 0.0088 0.0206 0.0516]
 [0.0306 0.0161 0.0249 0.0979]
 [0.0058 0.0208 0.0106 0.0231]
 [0.0105 0.0149 0.0207 0.0122]
 [0.0385 0.0219 0.004  0.0164]
 [0.0232 0.0407 0.019  0.1035]]
Test accuracy 0.8294407725334167 (source), 0.8077994585037231 (independent), 0.8155131936073303 (uniform), 0.17248769104480743 (adapted)
Test norm 0.0002976353280246258 (source), 0.000385964842280373 (independent), 0.00046819192357361317 (uniform), 0.0007067613769322634 (adapted)
---> Environment 1 (unseen)
Ground truth p(y, z) = [[0.0024 0.0024 0.0199 0.0725]
 [0.0029 0.0236 0.0029 0.0858]
 [0.0205 0.0025 0.0025 0.0745]
 [0.0766 0.0026 0.0026 0.0211]
 [0.0024 0.0024 0.02   0.0728]
 [0.0184 0.0022 0.0022 0.067 ]
 [0.0024 0.0024 0.0024 0.0896]
 [0.0027 0.0027 0.0796 0.0219]
 [0.0725 0.02   0.0024 0.0024]
 [0.0024 0.0024 0.0197 0.0716]]
Estimated p(y, z) = [[0.0009 0.0122 0.0543 0.0187]
 [0.0072 0.1213 0.0053 0.0104]
 [0.0847 0.048  0.0094 0.0273]
 [0.0004 0.0035 0.0095 0.0533]
 [0.0008 0.0214 0.0509 0.0153]
 [0.0746 0.0888 0.002  0.0323]
 [0.0005 0.0111 0.0224 0.051 ]
 [0.0005 0.0067 0.0049 0.0341]
 [0.0047 0.0692 0.0067 0.0064]
 [0.0005 0.0133 0.0104 0.0051]]
Test accuracy 0.8367260098457336 (source), 0.824941098690033 (independent), 0.8427255749702454 (uniform), 0.140775665640831 (adapted)
Test norm 0.0002485717704985291 (source), 0.0003343472781125456 (independent), 0.0004150493477936834 (uniform), 0.00087412737775594 (adapted)
---> Environment 2 (unseen)
Ground truth p(y, z) = [[0.0024 0.0024 0.0817 0.0112]
 [0.0028 0.0933 0.0028 0.0128]
 [0.0845 0.0025 0.0025 0.0116]
 [0.0114 0.0025 0.0025 0.0831]
 [0.0025 0.0025 0.082  0.0113]
 [0.076  0.0023 0.0023 0.0105]
 [0.0025 0.0025 0.0025 0.0932]
 [0.0025 0.0025 0.0116 0.0844]
 [0.0112 0.0811 0.0024 0.0024]
 [0.0025 0.0025 0.0848 0.0117]]
Estimated p(y, z) = [[1.6492e-08 1.0921e-11 4.2389e-02 1.3810e-16]
 [6.5836e-04 2.7359e-01 7.5995e-11 8.0851e-21]
 [2.0293e-01 4.4956e-09 3.5608e-06 1.1268e-16]
 [2.3063e-11 7.5842e-11 8.0755e-05 4.2515e-10]
 [1.1355e-04 7.7535e-06 2.7307e-01 7.0870e-19]
 [3.3670e-02 1.9246e-09 8.3884e-05 3.0886e-18]
 [4.0027e-05 1.0916e-09 2.8538e-04 3.8184e-08]
 [8.7105e-09 1.9269e-11 7.0635e-10 6.0698e-16]
 [2.6857e-07 4.4159e-04 6.7558e-05 1.5028e-16]
 [2.1549e-07 6.8854e-06 1.7256e-01 1.8721e-16]]
Test accuracy 0.748875081539154 (source), 0.8180844783782959 (independent), 0.8358688950538635 (uniform), 0.2509106695652008 (adapted)
Test norm 0.0004996080533601344 (source), 0.00047732883831486106 (independent), 0.00046857789857313037 (uniform), 0.0009175672312267125 (adapted)
```
